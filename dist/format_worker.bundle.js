(()=>{"use strict";const t="0123456789ABCDEF";function e(t){return new Uint8Array(t)}function n(...t){console.log(...t)}function r(e,n){n||(n=e<256?2:4);let r="";for(let a=0;a<n;a++)r=t[15&e]+r,e>>=4;return r}const a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function o(t){let e,n,r,o,s,i,c,l,d=0,f=0;const u=[];if(t){do{o=a.indexOf(t.charAt(d++)),s=a.indexOf(t.charAt(d++)),i=a.indexOf(t.charAt(d++)),c=a.indexOf(t.charAt(d++)),l=o<<18|s<<12|i<<6|c,e=l>>16&255,n=l>>8&255,r=255&l,u[f++]=e,64!==i&&(u[f++]=n),64!==c&&(u[f++]=r)}while(d<t.length);return new Uint8Array(u)}}var s=function(t,e,n,r){return new(n||(n=Promise))((function(a,o){function s(t){try{c(r.next(t))}catch(t){o(t)}}function i(t){try{c(r.throw(t))}catch(t){o(t)}}function c(t){var e;t.done?a(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(s,i)}c((r=r.apply(t,e||[])).next())}))};const i="nibble";class c{constructor(t,e,n=!1,r){this.format=t,this.metadata=e,this.readOnly=n,this.blocks=r,this.encoding="block"}blockCount(){return s(this,void 0,void 0,(function*(){return this.blocks.length}))}read(t){return s(this,void 0,void 0,(function*(){return this.blocks[t]}))}write(t,e){return s(this,void 0,void 0,(function*(){this.blocks[t]=e}))}}const l=["2mg","d13","do","dsk","po","nib"],d=[0,7,14,6,13,5,12,4,11,3,10,2,9,1,8,15],f=[0,8,1,9,2,10,3,11,4,12,5,13,6,14,7,15],u=[0,10,7,4,1,11,8,5,2,12,9,6,3],h=[171,173,174,175,181,182,183,186,187,189,190,191,214,215,218,219,221,222,223,234,235,237,238,239,245,246,247,250,251,253,254,255],w=[150,151,154,155,157,158,159,166,167,171,172,173,174,175,178,179,180,181,182,183,185,186,187,188,189,190,191,203,205,206,207,211,214,215,217,218,219,220,221,222,223,229,230,231,233,234,235,236,237,238,239,242,243,244,245,246,247,249,250,251,252,253,254,255];function E(t){let e=170&t,n=85&t;return e>>=1,e|=170,n|=170,[e,n]}function A(t,e,n,r){let a,o=[];a=0===n?128:0===e?40:38;for(let t=0;t<a;t++)o.push(255);const s=t^e^n;o=o.concat([213,170,150]),o=o.concat(E(t)),o=o.concat(E(e)),o=o.concat(E(n)),o=o.concat(E(s)),o=o.concat([222,170,235]);for(let t=0;t<5;t++)o.push(255);o=o.concat([213,170,173]);const i=[];for(let t=0;t<342;t++)i[t]=0;let c=85;for(let t=257;t>=0;t--){let e=r[t%256],n=i[0+c];n=n<<1|1&e,e>>=1,n=n<<1|1&e,e>>=1,i[86+t]=e,i[0+c]=n,--c<0&&(c=85)}let l=0;for(let t=0;t<342;t++){const e=i[t];o.push(w[l^e]),l=e}return o.push(w[l]),o=o.concat([222,170,235]),o.push(255),o}function g(t,e,n,r){let a,o=[];a=0===n?128:0===e?40:38;for(let t=0;t<a;t++)o.push(255);const s=t^e^n;o=o.concat([213,170,181]),o=o.concat(E(t)),o=o.concat(E(e)),o=o.concat(E(n)),o=o.concat(E(s)),o=o.concat([222,170,235]);for(let t=0;t<5;t++)o.push(255);o=o.concat([213,170,173]);const i=[];let c=0;for(let t=50;t>=0;t--){const e=r[c]>>3,n=7&r[c];c++;const a=r[c]>>3,o=7&r[c];c++;const s=r[c]>>3,l=7&r[c];c++;const d=r[c]>>3,f=7&r[c];c++;const u=r[c]>>3,h=7&r[c];c++,i[t+0]=e,i[t+51]=a,i[t+102]=s,i[t+153]=d,i[t+204]=u,i[t+256]=n<<2|(4&f)>>1|(4&h)>>2,i[t+307]=o<<2|2&f|(2&h)>>1,i[t+358]=l<<2|(1&f)<<1|1&h}i[255]=r[c]>>3,i[409]=7&r[c];let l=0;for(let t=409;t>=256;t--){const e=i[t];o.push(h[l^e]),l=e}for(let t=0;t<256;t++){const e=i[t];o.push(h[l^e]),l=e}return o.push(h[l]),o=o.concat([222,170,235]),o.push(255),o}var m;function b(t,e){let n=0,r=!0;for(;e<t.length&&(t[e]?(n=n<<1|1,r=!1):r||(n<<=1),!(128&n));)e+=1;return{nibble:n,offset:e}}function D(t){const{data:n,name:r,side:a,rawData:o,volume:s,readOnly:c}=t,l={format:"dsk",encoding:i,metadata:{name:r,side:a},volume:s,readOnly:c,tracks:[]};for(let t=0;t<35;t++){let r=[];for(let e=0;e<16;e++){const a=d[e];let i;if(o){const e=256*(16*t+a);i=new Uint8Array(o.slice(e,e+256))}else{if(!n)throw new Error("Requires data or rawData");i=new Uint8Array(n[t][a])}r=r.concat(A(s,t,e,i))}l.tracks[t]=e(r)}return l}function y(t){const{data:e,name:n,side:r,rawData:a,volume:o,readOnly:s}=t,c={format:"nib",encoding:i,metadata:{name:n,side:r},volume:o||254,readOnly:s||!1,tracks:[]};for(let t=0;t<35;t++){let n;if(a){const e=6656*t;n=new Uint8Array(a.slice(e,e+6656))}else{if(!e)throw new Error("Requires data or rawData");n=e[t][0]}c.tracks[t]=n}return c}!function(t){t[t.START_OF_FIELD_MARKER_FIRST_NIBBLE=0]="START_OF_FIELD_MARKER_FIRST_NIBBLE",t[t.START_OF_FIELD_MARKER_SECOND_NIBBLE=1]="START_OF_FIELD_MARKER_SECOND_NIBBLE",t[t.FIELD_TYPE_MARKER=2]="FIELD_TYPE_MARKER",t[t.ADDRESS_FIELD=3]="ADDRESS_FIELD",t[t.ADDRESS_FIELD_13=4]="ADDRESS_FIELD_13",t[t.DATA_FIELD_6AND2=5]="DATA_FIELD_6AND2",t[t.DATA_FIELD_5AND3=6]="DATA_FIELD_5AND3"}(m||(m={})),Error,Error,Error;const k=512;function O(t){const{data:n,name:r,side:a,rawData:o,volume:s,readOnly:l}=t;let d;if(o&&o.byteLength>143500){const t=[];for(let e=0;e<o.byteLength;e+=k)t.push(new Uint8Array(o.slice(e,e+k)));d=new c("po",{name:r,side:a},l||!1,t)}else{d={format:"po",encoding:i,metadata:{name:r,side:a},volume:s||254,tracks:[],readOnly:l||!1};for(let t=0;t<35;t++){let r=[];for(let e=0;e<16;e++){const a=f[e];let i;if(o){const e=256*(16*t+a);i=new Uint8Array(o.slice(e,e+256))}else{if(!n)throw new Error("Requires data or rawData");i=n[t][a]}r=r.concat(A(s,t,e,i))}d.tracks[t]=e(r)}}return d}const p={SIGNATURE:0,CREATOR:4,HEADER_LENGTH:8,VERSION:10,FORMAT:12,FLAGS:16,BLOCKS:20,DATA_OFFSET:24,DATA_LENGTH:28,COMMENT:32,COMMENT_LENGTH:36,CREATOR_DATA:40,CREATOR_DATA_LENGTH:44,PADDING:48},T={READ_ONLY:2147483648,VOLUME_VALID:256,VOLUME_MASK:255};var _;!function(t){t[t.DOS=0]="DOS",t[t.ProDOS=1]="ProDOS",t[t.NIB=2]="NIB"}(_||(_={}));function R(t,e,n){const r=new Uint8Array(t.buffer.slice(t.byteOffset+e,t.byteOffset+n));return String.fromCharCode(...r)}class S{constructor(t){this.sides=0,this.bootSector=0,this.bitTiming=0,this.compatibleHardware=0,this.requiredRAM=0,this.largestTrack=0,this.version=t.getUint8(0),this.diskType=t.getUint8(1),this.writeProtected=t.getUint8(2),this.synchronized=t.getUint8(3),this.cleaned=t.getUint8(4),this.creator=R(t,5,37),this.version>1&&(this.sides=t.getUint8(37),this.bootSector=t.getUint8(38),this.bitTiming=t.getUint8(39),this.compatibleHardware=t.getUint16(40,!0),this.requiredRAM=t.getUint16(42,!0),this.largestTrack=t.getUint16(44,!0))}}class L{constructor(t){this.trackMap=[];for(let e=0;e<160;e++)this.trackMap.push(t.getUint8(e))}}class U{}class I extends U{constructor(t){super(),this.rawTracks=[],this.tracks=[];for(let e=0,n=0;n<t.byteLength;n+=6656,e++){let r=[];const a=[],o=t.buffer.slice(t.byteOffset+n,t.byteOffset+n+6656),s=new Uint8Array(o),i=new DataView(o).getUint16(6648,!0);for(let t=0;t<i;t++){const e=t>>3,n=7-(7&t);a[t]=s[e]>>n&1?1:0}r=[];let c=0;for(;c<a.length;){const t=b(a,c);if(!t.nibble)break;r.push(t.nibble),c=t.offset+1}this.tracks[e]=new Uint8Array(r),this.rawTracks[e]=new Uint8Array(a)}}}class v extends U{constructor(t){let e;for(super(),this.trks=[],e=0;e<160;e++){const n=t.getUint16(8*e,!0),r=t.getUint16(8*e+2,!0),a=t.getUint32(8*e+4,!0);if(0===a)break;this.trks.push({startBlock:n,blockCount:r,bitCount:a})}this.tracks=[],this.rawTracks=[];const n=t.buffer;for(e=0;e<this.trks.length;e++){const t=this.trks[e];let r=[];const a=[],o=512*t.startBlock,s=o+512*t.blockCount,i=n.slice(o,s),c=new Uint8Array(i);for(let e=0;e<t.bitCount;e++){const t=e>>3,n=7-(7&e);a[e]=c[t]>>n&1?1:0}r=[];let l=0;for(;l<a.length;){const t=b(a,l);if(!t.nibble)break;r.push(t.nibble),l=t.offset+1}this.tracks[e]=new Uint8Array(r),this.rawTracks[e]=new Uint8Array(a)}}}class N{constructor(t){const e=R(t,0,t.byteLength).split("\n");this.values=e.reduce((function(t,e){const n=e.split("\t");return t[n[0]]=n[1],t}),{})}}function M(t,e){let a=null;switch(t){case"2mg":a=function(t){let e,{rawData:n}=t;if(!n)throw new Error("Requires rawData");const{bytes:r,format:a,offset:o,readOnly:s,volume:i}=function(t){const e=new DataView(t),n=new TextDecoder("ascii"),r=n.decode(t.slice(p.SIGNATURE,p.SIGNATURE+4));if("2IMG"!==r)throw new Error(`Unrecognized 2mg signature: ${r}`);const a=n.decode(t.slice(p.CREATOR,p.CREATOR+4)),o=e.getInt16(p.HEADER_LENGTH,!0);if(64!==o)throw new Error(`2mg header length is incorrect ${o} !== 64`);const s=e.getInt32(p.FORMAT,!0),i=e.getInt32(p.FLAGS,!0),c=e.getInt32(p.BLOCKS,!0),l=e.getInt32(p.DATA_OFFSET,!0),d=e.getInt32(p.DATA_LENGTH,!0),f=e.getInt32(p.COMMENT,!0),u=e.getInt32(p.COMMENT_LENGTH,!0),h=e.getInt32(p.CREATOR_DATA,!0),w=e.getInt32(p.CREATOR_DATA_LENGTH,!0);if(s===_.ProDOS&&512*c!==d)throw new Error(`2mg blocks does not match disk data length: ${c} * 512 !== ${d}`);if(l<o)throw new Error(`2mg data offset is less than header length: ${l} < ${o}`);if(l+d>e.byteLength)throw new Error(`2mg data extends beyond disk image: ${l} + ${d} > ${e.byteLength}`);const E=l+d;if(f&&f<E)throw new Error(`2mg comment is before the end of the disk data: ${f} < ${l} + ${d}`);const A=f?f+u:E;if(A>e.byteLength)throw new Error(`2mg comment extends beyond disk image: ${A} > ${e.byteLength}`);if(h&&h<A)throw new Error(`2mg creator data is before the end of the comment: ${h} < ${A}`);const g=h?h+w:A;if(g>e.byteLength)throw new Error(`2mg creator data extends beyond disk image: ${g} > ${e.byteLength}`);const m={};f&&(m.comment=new TextDecoder("utf-8").decode(new Uint8Array(t,f,u))),h&&(m.creatorData=new Uint8Array(t,h,w));const b=!!(i&T.READ_ONLY);let D=s===_.DOS?254:0;return i&T.VOLUME_VALID&&(D=i&T.VOLUME_MASK),Object.assign({bytes:d,creator:a,format:s,offset:l,readOnly:b,volume:D},m)}(n);switch(n=n.slice(o,o+r),t=Object.assign(Object.assign({},t),{rawData:n,readOnly:s,volume:i}),a){case _.ProDOS:e=O(t);break;case _.NIB:e=y(t);break;case _.DOS:default:e=D(t)}return e}(e);break;case"d13":a=function(t){const{data:e,name:n,side:r,rawData:a,volume:o,readOnly:s}=t,c={format:"d13",encoding:i,metadata:{name:n,side:r},volume:o,readOnly:s,tracks:[]};if(!e&&!a)throw new Error("data or rawData required");for(let t=0;t<35;t++){let n=[];for(let r=0;r<13;r++){const s=u[r];let i;if(a){const e=256*(13*t+s);i=new Uint8Array(a.slice(e,e+256))}else{if(!e)throw new Error("Requires data or rawData");i=e[t][s]}n=n.concat(g(o,t,s,i))}c.tracks.push(new Uint8Array(n))}return c}(e);break;case"do":case"dsk":a=D(e);break;case"nib":a=y(e);break;case"po":a=O(e);break;case"woz":a=function(t){const{rawData:e}=t;if(!e)throw new Error("Requires rawData");const a=new DataView(e,0);let o,s=0;const i={};function c(){if(s>=a.byteLength)return null;const t=a.getUint32(s,!0),e=a.getUint32(s+4,!0),n=new DataView(a.buffer,s+8,e);return s+=e+8,{type:t,size:e,data:n}}if(function(){switch(a.getUint32(0,!0)){case 828002135:o=1;break;case 844779351:o=2;break;default:return!1}return 168626943===a.getUint32(4,!0)}()){s=12;let t=c();for(;t;){switch(t.type){case 1330007625:i.info=new S(t.data);break;case 1346456916:i.tmap=new L(t.data);break;case 1397445204:i.trks=1===o?new I(t.data):new v(t.data);break;case 1096041805:i.meta=new N(t.data);break;case 1414091351:break;default:n("Unsupported chunk",r(t.type,8))}t=c()}}else n("Invalid woz header");const{meta:l,tmap:d,trks:f,info:u}=i;return{encoding:"bitstream",format:"woz",trackMap:(null==d?void 0:d.trackMap)||[],rawTracks:(null==f?void 0:f.rawTracks)||[],readOnly:!0,metadata:{name:(null==l?void 0:l.values.title)||t.name,side:(null==l?void 0:l.values.side_name)||(null==l?void 0:l.values.side)},info:u}}(e)}return a}n("Worker loaded"),addEventListener("message",(t=>{n("Worker started",t.type);const r=t.data,{driveNo:a}=r.payload;let s=null;switch(r.type){case"PROCESS_BINARY":{const{fmt:t,options:e}=r.payload;s=M(t,e)}break;case"PROCESS_JSON_DISK":{const{jsonDisk:t}=r.payload;s=function(t){const e=t.type,n=t.readOnly,r=t.name,a=t.disk;if(s=e,l.includes(s)){let s;if("base64"===t.encoding){s=[];for(let e=0;e<t.data.length;e++)if(s[e]=[],"nib"===t.type)s[e][0]=o(t.data[e]);else for(let n=0;n<t.data[e].length;n++)s[e][n]=o(t.data[e][n])}else s=t.data;return M(e,{volume:t.volume||254,readOnly:n,name:r,side:a,data:s})}return null;var s}(t)}break;case"PROCESS_JSON":{const{json:t}=r.payload;s=function(t){const n=[],r=JSON.parse(t),a=r.volume||254,s=r.readOnly||!1;for(let t=0;t<r.data.length;t++){let s=[];for(let e=0;e<r.data[t].length;e++){const n="po"===r.type?f[e]:d[e],i=o(r.data[t][n]);s=s.concat(A(a,t,e,i))}n[t]=e(s)}if(c=r.type,!l.includes(c))throw new Error(`JSON disks of type ${r.type} are not supported`);var c;return{volume:a,format:r.type,encoding:i,metadata:{name:r.name},tracks:n,readOnly:s}}(t)}}const c={type:"DISK_PROCESSED",payload:{driveNo:a,disk:s}};self.postMessage(c),n("Worker complete",t.type)}))})();
//# sourceMappingURL=format_worker.bundle.js.map